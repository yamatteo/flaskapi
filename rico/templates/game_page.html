{% extends "base.html" %}
{% from 'action_widget.html' import action_widget %}
{% from 'macros.html' import navbar_turn_badges, macrostyles, state_card, board_status %}
{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <span class="navbar-brand">{{ game.name }}</span>
    {{ navbar_turn_badges(turn_info) }}
    <ul class="navbar-nav">
      <li class="nav-item">
        <form class="d-inline" method="post" action="{{ url_for('logout') }}">
          <button type="submit" class="btn btn-secondary">Esci</button>
        </form>
      </li>
    </ul>
  </div>
</nav>

<div class="container mt-3">
  {% if game.status == "open" %}
    <p>
      La partita sta per iniziare. I giocatori sono: 
      {% for user in game.users %}
        {{user.name}}{{ ", " if not loop.last else "" }}
      {% endfor %}.
    </p>
    {% if game.users|length >= 3 and game.users|length <= 5 %}
      <form method="post" action="{{ url_for('start_game', game_id=game.id) }}">
        <button type="submit" class="btn btn-primary">Comincia il gioco</button>
      </form>
    {% endif %}
  {% elif game.status == "active" and turn_info and gd %}
    {% for info in turn_info %}
      {% if info.expected and info.is_you %}
        <div class="card">
          <h4 class="card-header">
            Ãˆ il tuo turno!
          </h4>
          <div class="card-body">
            {{ action_widget(gd.expected, gd.board, translation, explanation, BUILD_INFO) }}
          </div>
        </div>
      {% endif %}
      {% if info.is_you %}
      {{ state_card(gd.board.towns[info.pseudo], translation, True) }}
      {% endif %}
    {% endfor %}
    {% for info in turn_info %}
      {% if not info.is_you %}
      {{ state_card(gd.board.towns[info.pseudo], translation)}}
      {% endif %}
    {% endfor %}
    {{ board_status(gd.board, translation) }}
    <p>The game is active. This is your state ...</p>
    <p class="small">{{ game.dumped_data }}</p>
  {% elif game.status == "closed" %}
    <p>The game has ended. Here are the final scores.</p>
    <form method="post" action="{{ url_for('delete_game', game_id=game.id) }}">
      <button type="submit" class="btn btn-danger">Delete Game</button>
    </form>
  {% endif %}
</div>
{% endblock %} {% block scripts %}
<script>
  let lastStatus = "{{ game.status }}";
  let lastActionCounter = {{ game.action_counter }};
  let lastNumPlayers = {{ game.users| length }};

  function checkGameStatus() {
    fetch("{{ url_for('game_status', game_id=game.id) }}")
      .then(response => response.json())
      .then(data => {
        if (data.action_counter !== lastActionCounter || data.status !== lastStatus || data.num_players !== lastNumPlayers) {
          // Game status or action counter has changed, reload the page
          window.location.reload();
        }
      })
      .catch(error => console.error("Error fetching game status:", error));
  }

  // Check the game status every 5 seconds
  setInterval(checkGameStatus, 5000);
</script>
{% endblock %}

{% block styles %}
{{ macrostyles() }}
{% endblock %}